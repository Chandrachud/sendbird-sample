
var _isLeavingPage=false;window.onbeforeunload=function(){_isLeavingPage=true;};(function(root,factory){'use strict';if(typeof define==='function'&&define.amd){define([],factory);}else if(typeof exports==='object'){module.exports=factory();}else{root.sendbird=factory();}})(this,function(){'use strict';var _printDebugMessage=false;var _debugMessage=function(msg){if(_printDebugMessage){console.log(msg);}};var _extend=function(out){out=out||{};var argLen=arguments.length;for(var i=1;i<argLen;i++){if(!arguments[i]){continue;}
for(var key in arguments[i]){if(arguments[i].hasOwnProperty(key))
out[key]=arguments[i][key];}}
return out;};var _AJAX_SUCCESS_CODE=200;var _AJAX_ERROR_CODE=400;function _ajaxCall(url,data,successFunc,errorFunc){var request=new XMLHttpRequest();request.open('POST',url);request.setRequestHeader('Content-Type','text/plain; charset=UTF-8');request.onload=function(){if(request.status>=_AJAX_SUCCESS_CODE&&request.status<_AJAX_ERROR_CODE){var resp=request.responseText;successFunc(JSON.parse(resp));}else{errorFunc(request.status,request.statusText);}};request.send(JSON.stringify(data));}
var sendbird=(function(){function createSDKUrl(url){return API_URL+'v'+VERSION.replace(/[^(0-9)]/gi,'')+'/'+url;}
var VERSION='1';var WS_URL='wss://ws.jiver.co:9010';var API_URL='https://api.jiver.co/';var ws=null;var MESSAGE_CMD={"MESG":"MESG","FILE":"FILE","LOGI":"LOGI","JOIN":"JOIN","SYSM":"SYSM","BRDM":"BRDM","MCUP":"MCUP","READ":"READ","TPST":"TPST","TPEN":"TPEN","PING":"PING","PONG":"PONG"};var user={};var channel={};var lastActiveTS=0;var minMessageTS=0;var pingHandler=null;var watchdogHandler=null;var retryHandler=null;var lastPingTS=0;var isTyping=false;var typingTime=0;var TYPE_TIME=10000;var messageProcess=function(cmd,payload){switch(cmd){case MESSAGE_CMD["MESG"]:events.onMessageReceived(JSON.parse(payload));break;case MESSAGE_CMD["SYSM"]:events.onSystemMessageReceived(JSON.parse(payload));break;case MESSAGE_CMD["FILE"]:events.onFileMessageReceived(JSON.parse(payload));break;case MESSAGE_CMD["BRDM"]:events.onBroadcastMessageReceived(JSON.parse(payload));break;case MESSAGE_CMD["MCUP"]:events.onMessagingChannelUpdateReceived(JSON.parse(payload));break;case MESSAGE_CMD["TPST"]:events.onTypeStartReceived(JSON.parse(payload));break;case MESSAGE_CMD["TPEN"]:events.onTypeEndReceived(JSON.parse(payload));break;case MESSAGE_CMD["PONG"]:_debugMessage(MESSAGE_CMD["PONG"]);break;case MESSAGE_CMD["READ"]:events.onReadReceived(JSON.parse(payload));break;default:events.onUndefinedMessageReceived(cmd,JSON.parse(payload));break;}
return JSON.parse(payload);};var callBackOption={successFunc:function(data){},errorFunc:function(status,error){console.log(status);console.log(error);}};var events={onMessageReceived:function(obj){console.log(obj);},onSystemMessageReceived:function(obj){console.log(obj);},onFileMessageReceived:function(obj){console.log(obj);},onBroadcastMessageReceived:function(obj){console.log(obj);},onReadReceived:function(obj){console.log(obj)},onMessagingChannelUpdateReceived:function(obj){console.log(obj);},onTypeStartReceived:function(obj){console.log(obj);},onTypeEndReceived:function(obj){console.log(obj);},onMessageDelivery:function(obj){console.log(obj);},onUndefinedMessageReceived:function(cmd,obj){_debugMessage(cmd);_debugMessage(obj);}};var IS_GROUP_MESSAGING=6;var guestLogin=function(options){_debugMessage('=== Start SendBird SDK ===');var ajaxOption=_extend({},callBackOption,options);var url='guest_login/';var data={"guest_id":user['guest_id'],"app_id":user['app_id'],"nickname":user['user_name'],"image_url":user['image_url'],"access_token":user['access_token']};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{user['guest_key']=data['key'];ajaxOption.successFunc({});}},function(status,error){ajaxOption.errorFunc(status,error);});};var joinChannel=function(channelUrl,options){_debugMessage('=== Join Channel ===');var ajaxOption=_extend({},callBackOption,options);var url='channel_join/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channelUrl};var channelInfo={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{_extend(channel,data);channelInfo=channel;ajaxOption.successFunc(channelInfo);}},function(status,error){ajaxOption.errorFunc(status,error);});};var leaveChannel=function(channelUrl,options){_debugMessage('=== Leave Channel ===');var ajaxOption=_extend({},callBackOption,options);var url='channel_leave';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channelUrl};var leaveChannel={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{leaveChannel=data;ajaxOption.successFunc(leaveChannel);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getMemberList=function(channelUrl,options){_debugMessage('=== Member List ===');var ajaxOption=_extend({},callBackOption,options);var url='member_list/';var data={"app_id":user['app_id'],"channel_url":channelUrl};var memberList={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{memberList=data;ajaxOption.successFunc(memberList);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getChannelSearch=function(options){_debugMessage('=== Channel List ===');options=_extend({},{"limit":20,"page":1,"query":""},options);var ajaxOption=_extend({},callBackOption,options);var url='channel_list/';var data={"app_id":user['app_id'],"page":ajaxOption["page"],"limit":ajaxOption["limit"],"query":ajaxOption["query"]};var channelList={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{channelList=data;ajaxOption.successFunc(channelList);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getChannelList=function(options){getChannelSearch(options);};var joinMessagingChannel=function(channelUrl,options){_debugMessage('=== Join Messaging Channel ===');var ajaxOption=_extend({},callBackOption,options);var url='messaging_join/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channelUrl};var channelInfo={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{_extend(channel,data.channel);channelInfo=data;ajaxOption.successFunc(channelInfo);}},function(status,error){ajaxOption.errorFunc(status,error);});};var startMessaging=function(guestIds,options){_debugMessage('=== Start Messaging ===');guestIds=guestIds instanceof Array?guestIds:new Array(guestIds);var ajaxOption=_extend({},callBackOption,options);var url='messaging_start/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"guest_ids":guestIds};var messagingChannel={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{_extend(channel,data.channel);messagingChannel=data;ajaxOption.successFunc(messagingChannel);}},function(status,error){ajaxOption.errorFunc(status,error);});};var inviteMessaging=function(guestIds,options){_debugMessage('=== Invite Messaging ===');guestIds=guestIds instanceof Array?guestIds:new Array(guestIds);var ajaxOption=_extend({},callBackOption,options);var url='messaging_invite/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channel['channel_url'],"guest_ids":guestIds};var messagingChannel={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{_extend(channel,data.channel);messagingChannel=data;ajaxOption.successFunc(messagingChannel);}},function(status,error){ajaxOption.errorFunc(status,error);});};var endMessaging=function(channelUrl,options){_debugMessage('=== End Messaging ===');var ajaxOption=_extend({},callBackOption,options);var url='messaging_end/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channelUrl};var messagingChannel={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{_extend(channel,data);messagingChannel=data;ajaxOption.successFunc(messagingChannel);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getMessagingChannelList=function(options){_debugMessage('=== Messaging Channel List ===');options=_extend({},{"limit":9999,"page":1},options);var ajaxOption=_extend({},callBackOption,options);var url='messaging_list/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"page":ajaxOption["page"],"limit":ajaxOption["limit"]};var channelList={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{channelList=data;ajaxOption.successFunc(channelList);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getMessagingChannelInfo=function(channelId,options){_debugMessage('=== Messaging Channel Info ===');var ajaxOption=_extend({},callBackOption,options);var url='messaging_info/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_id":channelId};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{events.onMessagingChannelUpdateReceived(data);}},function(status,error){ajaxOption.errorFunc(status,error);});};var markAsRead=function(channelUrl,options){_debugMessage('=== Message Mark As Read ===');var ajaxOption=_extend({},callBackOption,options);var url='mark_as_read/';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channelUrl};var channelInfo={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{channelInfo=data;ajaxOption.successFunc(channelInfo);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getMessageLoadMore=function(options){_debugMessage('=== Message Load More ===');options=_extend({},{"limit":20},options);var ajaxOption=_extend({},callBackOption,options);var now=new Date().getTime();var url='message_list';var data={"app_id":user['app_id'],"session_key":user['guest_key'],"channel_url":channel['channel_url'],"message_ts":minMessageTS==0?now:minMessageTS,"prev_limit":ajaxOption["limit"],"next_limit":0,"include":false};var messageList={};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{messageList=data;$.each(messageList['messages'],function(index,msg){var payload=JSON.parse(msg.substring(4));if(minMessageTS==0){minMessageTS=payload['ts'];}else if(minMessageTS>payload['ts']){minMessageTS=payload['ts'];}});ajaxOption.successFunc(messageList);}},function(status,error){ajaxOption.errorFunc(status,error);});};var getUserList=function(options){_debugMessage('=== User List ===');options=_extend({},{"token":'',"page":1,"limit":30},options);var ajaxOption=_extend({},callBackOption,options);var url='user_list/';var data={"app_id":user["app_id"],"session_key":user['guest_key'],"token":ajaxOption["token"],"page":ajaxOption["page"],"limit":ajaxOption["limit"]};_ajaxCall(createSDKUrl(url),data,function(data){if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{ajaxOption.successFunc(data);}},function(status,error){ajaxOption.errorFunc(status,error);});};var sendFile=function(file,options){_debugMessage('=== Upload File ===');var ajaxOption=_extend({},callBackOption,options);var url='upload_file/';var meta='{"app_id": "'+user['app_id']+'"}';var formData=new FormData();formData.append("meta",meta);formData.append("file",file);var fileData='';var sendFileUrl=API_URL+'v'+VERSION.replace(/[^(0-9)]/gi,'')+'/'+url;var request=new XMLHttpRequest();request.open('POST',sendFileUrl,ajaxOption["async"]);request.onload=function(){if(request.status>=_AJAX_SUCCESS_CODE&&request.status<_AJAX_ERROR_CODE){var resp=request.responseText;var data=JSON.parse(resp);if(data.error){ajaxOption.errorFunc(_AJAX_SUCCESS_CODE,data["message"]);}else{fileData={"error":false,"url":data['url']};sendFileURL({"url":data['url'],"name":file.name,"type":file.type,"size":file.size,"custom":''});ajaxOption.successFunc(fileData);}}else{ajaxOption.errorFunc(request.status,request.statusText);}};request.send(formData);};var typeStart=function(){_debugMessage('=== Typing Start ===');var now=new Date().getTime();command(MESSAGE_CMD["TPST"],{"channel_id":channel['id'],"time":now});typingTime=now;isTyping=true;};var typeEnd=function(){_debugMessage('=== Typing End ===');var now=new Date().getTime();command(MESSAGE_CMD["TPEN"],{"channel_id":channel['id'],"time":now});typingTime=0;isTyping=false;};var checkTyping=setInterval(function(){var now=new Date().getTime();if(isTyping){if(now-typingTime>TYPE_TIME){typeEnd();}}},TYPE_TIME);var connect=function(){_debugMessage('=== Web Socket Connect ===');clearWebSocket();ws=new WebSocket(WS_URL);ws.onopen=function(e){login(user['guest_key']);var now=new Date().getTime();join(channel['id'],now);pinger(true);};ws.onmessage=function(e){lastActiveTS=new Date().getTime();var lines=e.data.split('\n');for(var i=0;i<lines.length;i++){if(lines[i].trim().length==0){continue;}
var cmd=lines[i].substring(0,4);var payload=lines[i].substring(4);if(cmd.trim().length===0&&payload.trim().length===0){continue;}
if(cmd===MESSAGE_CMD["PONG"]){watchdog(false);}else if(cmd==MESSAGE_CMD["MCUP"]){var jsonPayload=JSON.parse(payload);getMessagingChannelInfo(jsonPayload['channel_id']);}else{messageProcess(cmd,payload);}}};ws.onerror=function(e){_debugMessage('=== Web Socket onerror ===');_debugMessage(e);if(!isLeavingPage){reconnect();}
pinger(false);watchdog(false);};ws.onclose=function(e){_debugMessage('=== Web Socket onclose ===');_debugMessage(e);if(!isLeavingPage){reconnect();}
pinger(false);watchdog(false);};};var disconnect=function(){_debugMessage('=== Web Socket Disconnect ===');clearConnection();};var reconnect=function(){if(retryHandler==null){_debugMessage('=== Start Reconnect ===');retryHandler=setTimeout(function(){connect();retryHandler=null;_debugMessage("=== Reconnect done ===");},3000);}else{_debugMessage("=== Reconnect is in progress. (skip) ===");}};var clearConnection=function(){if(ws){clearWebSocket();}
channel={};minMessageTS=0;pingHandler=null;watchdogHandler=null;retryHandler=null;lastPingTS=0;};var clearWebSocket=function(){if(ws){ws.close();ws.onmessage=function(e){};ws.onopen=function(e){};ws.onerror=function(e){};ws.onclose=function(e){};ws=null;}
minMessageTS=0;};var command=function(command,data){var msg=command+JSON.stringify(data)+'\n';try{if(ws.readyState==1){ws.send(msg);}else{return false;}}catch(e){console.log(e);return false;}
return true;};var login=function(key){command(MESSAGE_CMD["LOGI"],{key:key});};var join=function(channel,now){command(MESSAGE_CMD["JOIN"],{channel_id:channel,last_message_ts:now});};var ping=function(){var now=new Date().getTime();lastPingTS=now;command(MESSAGE_CMD["PING"],{"id":now});};var pinger=function(start){if(pingHandler!=null){clearInterval(pingHandler);pingHandler=null;}
if(start){_debugMessage("=== Start Pinger ===");pingHandler=setInterval(function(){var now=new Date().getTime();var diff=now-lastActiveTS;var diffSec=parseInt(diff/1000);if(diffSec>0&&diffSec%5==0){_debugMessage(MESSAGE_CMD["PING"]);ping();watchdog(true);}},1000);}else{_debugMessage("=== Stop Pinger ===");}};var watchdog=function(start){if(watchdogHandler!=null){clearInterval(watchdogHandler);watchdogHandler=null;}
if(start){_debugMessage("=== Start Watchdog ===");watchdogHandler=setInterval(function(){var now=new Date().getTime();var diff=now-lastActiveTS;var diffSec=parseInt(diff/1000);if(diffSec>=20){_debugMessage("=== Watchdog Barks! ===");pinger(false);reconnect();}},4500);}else{_debugMessage("=== Watchdog ===");}};var message=function(msg,tid){tid=tid||"";var flag=command(MESSAGE_CMD["MESG"],{"channel_id":channel['id'],"message":msg,"data":"","tid":tid});events.onMessageDelivery({"sent":flag,"message":msg,"data":"","id":tid});if(flag){setTimeout(function(){typeEnd();},100);}};var messageWithData=function(msg,data,tid){tid=tid||"";var flag=command(MESSAGE_CMD["MESG"],{"channel_id":channel['id'],"message":msg,"data":data,"tid":tid});events.onMessageDelivery({"sent":flag,"message":msg,"data":data,"tid":tid});if(flag){setTimeout(function(){typeEnd();},100);}};var sendFileURL=function(fileInfo){command(MESSAGE_CMD["FILE"],{"channel_id":channel['id'],"name":fileInfo['name'],"url":fileInfo['url'],"type":fileInfo['type'],"size":fileInfo['size'],"custom":fileInfo['custom']});};var setDebugMessage=function(flag){_printDebugMessage=flag;};var commandSeparate=function(data){var cmd=data.substring(0,4);var payload=JSON.parse(data.substring(4));return{"cmd":cmd,"payload":payload};};var isMessage=function(cmd){return cmd==MESSAGE_CMD["MESG"];};var isFileMessage=function(cmd){return cmd==MESSAGE_CMD["FILE"];};var hasImage=function(payload){var urls=payload.url.split('.');var imgType=urls[urls.length-1];if(imgType=='png'||imgType=='jpeg'||imgType=='jpg'||imgType=='gif'||imgType=='bmp'){return true;}
return payload.type.indexOf('image')>=0;};var isGroupMessaging=function(channelType){return channelType==IS_GROUP_MESSAGING;};function init(userOption){user["app_id"]=userOption["app_id"];user["guest_id"]=userOption["guest_id"];user["user_name"]=userOption["user_name"];user["image_url"]=(userOption["image_url"]==undefined||userOption["image_url"]==null)?'':userOption["image_url"];user["access_token"]=(userOption["access_token"]==undefined||userOption["access_token"]==null)?'':userOption["access_token"];guestLogin({"successFunc":function(data){userOption.successFunc(data);},"errorFunc":function(status,error){userOption.errorFunc(status,error);},"async":userOption["async"]});}
return{events:events,joinChannel:joinChannel,leaveChannel:leaveChannel,getMemberList:getMemberList,getChannelSearch:getChannelSearch,getChannelList:getChannelList,joinMessagingChannel:joinMessagingChannel,startMessaging:startMessaging,inviteMessaging:inviteMessaging,endMessaging:endMessaging,getMessagingChannelList:getMessagingChannelList,markAsRead:markAsRead,getMessageLoadMore:getMessageLoadMore,getUserList:getUserList,sendFile:sendFile,typeStart:typeStart,connect:connect,disconnect:disconnect,message:message,messageWithData:messageWithData,sendFileURL:sendFileURL,setDebugMessage:setDebugMessage,commandSeparate:commandSeparate,isMessage:isMessage,isFileMessage:isFileMessage,hasImage:hasImage,isGroupMessaging:isGroupMessaging,init:init};})();return sendbird;});