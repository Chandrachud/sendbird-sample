var SendBird,isLeavingPage=!1;$(window).unload(function(){isLeavingPage=!0}),SendBird=function(e){function n(e,n,t,s,i){i=i||!1,$.ajax({"method":"POST","url":e,"contentType":"text/plain;charset=utf-8","data":JSON.stringify(n),"async":i}).success(function(e){t(e)}).fail(function(e,n,t){s(e,n,t)})}function t(e){return y+"v"+v.replace(/[^(0-9)]/gi,"")+"/"+e}var s,i,a,c,r,o,u,g,l,d,p,f=this,_=!1,v="1",S="wss://ws.jiver.co:9010",y="https://api.jiver.co/",M=null,h={"MESG":"MESG","FILE":"FILE","STRU":"STRU","LOGI":"LOGI","JOIN":"JOIN","SYSM":"SYSM","BRDM":"BRDM","MCUP":"MCUP","PING":"PING","PONG":"PONG"},m={},k={},F=0,O=0,x=0,N=null,R=null,I=null,b=0,C=function(e,n){switch(e){case h.MESG:f.events.onMessageReceived(JSON.parse(n));break;case h.SYSM:f.events.onSystemMessageReceived(JSON.parse(n));break;case h.FILE:f.events.onFileMessageReceived(JSON.parse(n));break;case h.STRU:f.events.onStructuedMessageReceived(JSON.parse(n));break;case h.BRDM:f.events.onBroadcastMessageReceived(JSON.parse(n));break;case h.MCUP:f.events.onMessagingChannelUpdateReceived(JSON.parse(n));break;case h.PONG:s(h.PONG);break;default:f.events.onUndefinedMessageReceived(e,JSON.parse(n))}return JSON.parse(n)},P={"successFunc":function(e){console.log(e)},"errorFunc":function(e,n,t){console.log(e),console.log(n),console.log(t)},"async":!1};f.events={"onMessageReceived":function(e){console.log(e)},"onSystemMessageReceived":function(e){console.log(e)},"onFileMessageReceived":function(e){console.log(e)},"onBroadcastMessageReceived":function(e){console.log(e)},"onStructuedMessageReceived":function(e){console.log(e)},"onMessagingChannelUpdateReceived":function(e){console.log(e)},"onUndefinedMessageReceived":function(e,n){s(e),s(n)}},s=function(e){_&&console.log(e)},i=function(e){var i,a,c,r;s("=== Start SendBird SDK ==="),i=$.extend({},P,e),a="guest_login/",c={"guest_id":m.guest_id,"app_id":m.app_id,"nickname":m.user_name,"image_url":m.image_url},r={},n(t(a),c,function(e){return m.guest_key=e.key,i.successFunc(m),r=m},function(e,n,t){return i.errorFunc(e,n,t),r},i.async)},f.joinChannel=function(e,i){var a,c,r,o;s("=== Join Channel ==="),a=$.extend({},P,i),c="channel_join/",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":e},o={},n(t(c),r,function(e){return $.extend(k,e),o=k,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.leaveChannel=function(e,i){var a,c,r,o;s("=== Leave Channel ==="),a=$.extend({},P,i),c="channel_leave",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":e},o={},n(t(c),r,function(e){return o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.getMemberList=function(e,i){var a,c,r,o;s("=== Member List ==="),a=$.extend({},P,i),c="member_list/",r={"app_id":m.app_id,"channel_url":e},o={},n(t(c),r,function(e){return o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.getChannelSearch=function(e){var i,a,c,r;s("=== Channel List ==="),e=$.extend({},{"limit":20,"page":1,"query":""},e),i=$.extend({},P,e),a="channel_list/",c={"app_id":m.app_id,"page":i.page,"limit":i.limit,"query":i.query},r={},n(t(a),c,function(e){return r=e,i.successFunc(r),r},function(e,n,t){return i.errorFunc(e,n,t),r},i.async)},f.joinMessagingChannel=function(e,i){var a,c,r,o;s("=== Join Messaging Channel ==="),a=$.extend({},P,i),c="messaging_join/",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":e},o={},n(t(c),r,function(e){return $.extend(k,e.channel),o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.startMessaging=function(e,i){var a,c,r,o;s("=== Start Messaging ==="),a=$.extend({},P,i),c="messaging_start/",r={"app_id":m.app_id,"session_key":m.guest_key,"guest_id":e},o={},n(t(c),r,function(e){return $.extend(k,e.channel),o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.inviteMessaging=function(e,i){var a,c,r,o;s("=== Invite Messaging ==="),a=$.extend({},P,i),c="messaging_invite/",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":k.channel_url,"guest_ids":[e]},o={},n(t(c),r,function(e){return $.extend(k,e.channel),o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.endMessaging=function(e,i){var a,c,r,o;s("=== End Messaging ==="),a=$.extend({},P,i),c="messaging_end/",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":e},o={},n(t(c),r,function(e){return $.extend(k,e),o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.getMessagingChannelList=function(e){var i,a,c,r;s("=== Messaging Channel List ==="),e=$.extend({},{"limit":9999,"page":1},e),i=$.extend({},P,e),a="messaging_list/",c={"app_id":m.app_id,"session_key":m.guest_key,"page":i.page,"limit":i.limit},r={},n(t(a),c,function(e){return r=e,i.successFunc(r),r},function(e,n,t){return i.errorFunc(e,n,t),r},i.async)},f.getMessagingChannelInfo=function(e,i){var a,c,r,o;s("=== Messaging Channel Info ==="),a=$.extend({},P,i),c="messaging_info/",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_id":e},o={},n(t(c),r,function(e){return o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.markAsRead=function(e,i){var a,c,r,o;s("=== Message Mark As Read ==="),a=$.extend({},P,i),c="mark_as_read/",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":e},o={},n(t(c),r,function(e){return o=e,a.successFunc(o),o},function(e,n,t){return a.errorFunc(e,n,t),o},a.async)},f.getMessageLoadMore=function(e){var i,a,c,r,o;s("=== Message Load More ==="),i=$.extend({},P,e),a=(new Date).getTime(),c="message_list",r={"app_id":m.app_id,"session_key":m.guest_key,"channel_url":k.channel_url,"message_ts":0==x?a:x,"prev_limit":20,"next_limit":0,"include":!1},o={},n(t(c),r,function(e){return e.error?o={"messages":[]}:(o=e,$.each(o.messages,function(e,n){var t=JSON.parse(n.substring(4));0==x?x=t.ts:x>t.ts&&(x=t.ts),x>O&&(O=x)})),i.successFunc(o),o},function(e,n,t){return i.errorFunc(e,n,t),o},i.async)},f.uploadFile=function(e,n,t){var i,a,c,r,o;return s("=== Upload File ==="),i=$.extend({},P,t),a="upload_file/",c='{"app_id": "'+m.app_id+'"}',r=new FormData,r.append("meta",c),r.append("file",e),o="",$.ajax({"type":"POST","url":y+"v"+v.replace(/[^(0-9)]/gi,"")+"/"+a,"data":r,"processData":!1,"contentType":!1,"async":i.async,"success":function(e){o=e.url,void 0!=n&&null!=n&&(n.url=o,f.fileMessage(n)),i.successFunc(o)},"fail":function(e,n,t){i.errorFunc(e,n,t)}}),o},f.connect=function(){s("=== Web Socket Start ==="),r(),M=new WebSocket(S),M.onopen=function(){u(m.guest_key);var e=(new Date).getTime();g(k.id,e),d(!0)},M.onmessage=function(e){var n,t,s,i;for(F=(new Date).getTime(),n=e.data.split("\n"),t=0;t<n.length;t++)0!=n[t].trim().length&&(s=n[t].substring(0,4),i=n[t].substring(4),(0!==s.trim().length||0!==i.trim().length)&&(s===h.PONG?p(!1):s==h.MCUP?C(s,i):O<JSON.parse(i).ts&&(O=JSON.parse(i).ts,C(s,i))))},M.onerror=function(){s("on error"),isLeavingPage||a(),d(!1),p(!1)},M.onclose=function(){s("=== Web Socket onclose ==="),isLeavingPage||a(),d(!1),p(!1)}},f.disconnect=function(){s("=== Web Socket Start ==="),c()},a=function(){null==I?(s("=== Start Reconnect ==="),s("Retry starts."),I=setTimeout(function(){f.connect(),I=null,s("=== Reconnect done ===")},3e3)):s("=== Reconnect is in progress. (skip) ===")},c=function(){M&&(r(),O=0)},r=function(){M&&(M.close(),M.onmessage=function(){},M.onopen=function(){},M.onerror=function(){},M.onclose=function(){},M=null)},o=function(e,n){var t=e+JSON.stringify(n)+"\n";M&&M.send(t)},u=function(e){o(h.LOGI,{"key":e})},g=function(e,n){o(h.JOIN,{"channel_id":e,"last_message_ts":n})},l=function(){var e=(new Date).getTime();b=e,o(h.PING,{"id":e})},d=function(e){null!=N&&(clearInterval(N),N=null),e?(s("=== Start Pinger ==="),N=setInterval(function(){var e=(new Date).getTime(),n=e-F,t=parseInt(n/1e3);t>0&&t%5==0&&(s(h.PING),l(),p(!0))},1e3)):s("=== Stop Pinger ===")},p=function(e){null!=R&&(clearInterval(R),R=null),e?(s("=== Start Watchdog ==="),R=setInterval(function(){var e=(new Date).getTime(),n=e-F,t=parseInt(n/1e3);20>t||(s("=== Watchdog Barks! ==="),d(!1),a())},4500)):s("=== Watchdog ===")},f.message=function(e){o(h.MESG,{"channel_id":k.id,"message":e})},f.fileMessage=function(e){o(h.FILE,{"channel_id":k.id,"name":e.name,"url":e.url,"type":e.type,"size":e.size,"custom":e.custom})},Object.defineProperties(this,{"MESSAGE_CMD":{"get":function(){return h}},"printDebugMessage":{"get":function(){return _},"set":function(e){_=e}}}),$.extend(m,e),i()},SendBird.prototype.setDebugMessage=function(e){this.printDebugMessage=e},SendBird.prototype.commandSeparate=function(e){var n=e.substring(0,4),t=JSON.parse(e.substring(4));return{"cmd":n,"payload":t}},SendBird.prototype.isMessage=function(e){return e==this.MESSAGE_CMD.MESG},SendBird.prototype.isFileMessage=function(e){return e==this.MESSAGE_CMD.FILE},SendBird.prototype.hasImage=function(e){return e.type.indexOf("image")>=0},SendBird.prototype.getChannelList=function(e){return this.getChannelSearch(e)};